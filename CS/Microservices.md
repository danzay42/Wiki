Документ описывает основные требования и подходы к разработке микросервисов.

Термины «НЕОБХОДИМО» («ДОЛЖЕН»), «НЕДОПУСТИМО» («НЕ ДОЛЖЕН»), «ТРЕБУЕТСЯ», «НУЖНО», «СЛЕДУЕТ» («РЕКОМЕНДУЕТСЯ»), «НЕ СЛЕДУЕТ» («НЕ РЕКОМЕНДУЕТСЯ»), «ВОЗМОЖНО» («МОЖЕТ») и «НЕОБЯЗАТЕЛЬНЫЙ» («НЕОБЯЗАТЕЛЬНО») в данном документе следует интерпретировать как описано в [RFC 2119](http://rfc.com.ru/rfc2119.htm).

[Микросервис](https://ru.wikipedia.org/wiki/%d0%9c%d0%b8%d0%ba%d1%80%d0%be%d1%81%d0%b5%d1%80%d0%b2%d0%b8%d1%81%d1%8b) (здесь и далее «сервис») — это небольшой логически и физически изолированный (слабо связанный с другими сервисами) компонент, реализующий некий бизнес-функционал.
# Общие принципы

1. Сервисам СЛЕДУЕТ реализовывать функционал, соответствующий некой бизнес-потребности. Например, сервис поиска товаров или сервис хранения изображений. НЕ СЛЕДУЕТ делать сервисы слишком большими и универсальными (например, НЕ СЛЕДУЕТ реализовывать сервис веб-сайта). 
2. [Мандат Безоса](https://jesusgilhernandez.com/2012/10/18/jeff-bezos-mandate-amazon-and-web-services/) (ниже в переводе отражена суть и добавлены примеры, это не 100% точный перевод, так как никого увольнять за нарушение мандата мы не хотим):
	- Всем командам НЕОБХОДИМО предоставлять доступ к данным и функциональности только через интерфейсы сервисов.
	- Командам НЕОБХОДИМО взаимодействовать друг с другом (в смысле взаимодействия на уровне кода и приложений) только через эти интерфейсы.
	- Любые другие формы взаимодействия НЕДОПУСТИМЫ (включая, но не ограничиваясь прямыми запросами в базу данных другого сервиса/команды, использованием разделяемой памяти, обменом данными через файловую систему).
	- Вышеобозначенные требования НЕОБХОДИМО соблюдать независимо от используемых протоколов передачи информации и моделей взаимодействия (HTTP, gRPC, Corba, Pub-Sub и т.д.).
	- Все интерфейсы сервисов без исключения НЕОБХОДИМО проектировать так, чтобы при необходимости доступ к ним можно было предоставить разработчикам из внешнего мира (НЕДОПУСТИМЫ неявные соглашения уровня «вот в этом параметре всегда надо передавать 42 или работать не будет, а допустимый набор значений этого параметра знает Вася, спроси у него»).
3. Graceful degradation: в случае невозможности удовлетворения каких-либо зависимостей, требующихся для работы сервиса, сервису НЕОБХОДИМО стараться сохранить максимум функциональности. Пример:
    - Если сервис не может записать логи на диск по причине закончившегося свободного места — ему НЕОБХОДИМО продолжать работать для своих клиентов без изменений в поведении.
    - Если сервис по рендерингу HTML (фронт) не может получить от сервиса, управляющего ротацией рекламы, информацию о том, какой баннер нужно показать — фронту НЕОБХОДИМО отрендерить всю страницу за исключением блока с баннером (а не показывать пользователю страницу с ошибкой).
4. Сервисам [НЕ СЛЕДУЕТ сохранять состояние](https://ru.wikipedia.org/wiki/%d0%9f%d1%80%d0%be%d1%82%d0%be%d0%ba%d0%be%d0%bb_%d0%b1%d0%b5%d0%b7_%d1%81%d0%be%d1%85%d1%80%d0%b0%d0%bd%d0%b5%d0%bd%d0%b8%d1%8f_%d1%81%d0%be%d1%81%d1%82%d0%be%d1%8f%d0%bd%d0%b8%d1%8f) между разными запросами. Для хранения состояния СЛЕДУЕТ использовать внешнее по отношению к сервису хранилище (базу данных, файловое хранилище и т.д.).
5. Экземплярам сервиса СЛЕДУЕТ быть независимыми друг от друга и стремиться минимизировать трафик между собой.
6. Сервису НЕ ПОЗВОЛЯЕТСЯ рассчитывать на то, что его экземпляр будет запущен на каком-то определённом физическом сервере.
7. Сервису НЕОБХОДИМО иметь тесты (юнит, функциональные, интеграционные) и поддерживать их в актуальном состоянии. Тестам СЛЕДУЕТ быть небольшими, быстрыми и не зависеть от окружения, в котором они выполняются. НЕОБХОДИМО иметь покрытие нового функционала Unit-тестами. Unit-тесты — тесты, объектом тестирования которых является функция, метод класса, целый класс или сервис. Unit-тест может запускаться без компилирования сервиса. Если тест требует деплоя сервиса или вызова нескольких сервисов — это интеграционный тест. ВОЗМОЖНО использовать базу данных в Unit-тестах. НЕОБХОДИМО изолировать базу данных (например, развернуть gitlab services). НЕОБХОДИМО использовать тестовые дубли (mock, stub, spy, fake, dummy) в Unit-тестах. Покрытие Unit-тестами считается по коду. Подсчет покрытия Unit-тестами не требует инструментирования кода из вне. Покрытие Unit-тестами не отменяет необходимость покрытия интеграционными и сквозынми тестами.    
6. НЕДОПУСТИМО реализовывать бизнес-логику за пределами сервисов. То есть НЕДОПУСТИМО использование хранимых процедур, триггеров и внешних ключей (foreign keys) в реляционных базах данных. НЕДОПУСТИМО использование lua-скриптов в хранилищах типа Tarantool.